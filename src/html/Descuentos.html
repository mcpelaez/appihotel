<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nido Sky - Descuentos</title>
    <link
      rel="shortcut icon"
      type="image/png"
      href="../assets/images/logos/nidosky.png"
    />
    <link rel="stylesheet" href="../assets/css/styles.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      body {
        background-color: #e0e0e0;
        color: #333;
      }
      .left-sidebar {
        background-color: #ffffff;
      }
      .brand-logo {
        background-color: #333;
        padding: 20px;
      }
      .sidebar-nav .sidebar-item a {
        color: #333;
      }
      .sidebar-nav .sidebar-item a:hover {
        color: #00a859;
      }
      h5.card-title {
        color: #096038;
      }
      .btn-primary {
        background-color: #096038;
        border-color: #096038;
      }
      .btn-primary:hover {
        background-color: #096038;
        border-color: #096038;
      }
      .btn-excel {
        background-color: #096038;
        color: #fff;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
      }
      .btn-excel i {
        margin-right: 5px;
      }
      .btn-status {
        border: none;
        border-radius: 30%;
        width: 1.7rem;
        height: 1.7rem;
        color: #fff;
        font-size: 0.5rem;
        cursor: pointer;
        transition: background-color 0.3s, color 0.3s;
      }
      .btn-status:hover {
        opacity: 0.8;
      }
      .table {
        background-color: #333;
        color: #e0e0e0;
        font-size: 0.875rem;
      }
      .table th,
      .table td {
        border-color: #333;
        white-space: nowrap;
        padding: 0.5rem;
      }
      .table th {
        font-weight: 600;
      }
      .table td {
        font-weight: 400;
      }
      .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }
      .container {
        background-color: #f8f9fa;
        border-radius: 10px;
        position: relative;
        top: 200px;
        left: 70px;
        padding: 15px;
      }
      .table-dark {
        background-color: #333;
      }
      .table-dark th,
      .table-dark td {
        color: #fff;
      }
      .btn-success {
        background-color: #28a745;
        border: none;
      }
      .btn-outline-success {
        border-color: #28a745;
        color: #28a745;
      }
      .modal-content {
        border-radius: 10px;
      }
      .form-control {
        border-radius: 5px;
      }
      .app-header {
        position: relative;
        top: 30px;
      }
      .text-success {
        color: #096038;
      }
      .dropdown-menu {
        right: 0;
        left: auto;
      }
    </style>
  </head>
  <body>
    <div
      class="page-wrapper"
      id="main-wrapper"
      data-layout="vertical"
      data-navbarbg="skin6"
      data-sidebartype="full"
      data-sidebar-position="fixed"
      data-header-position="fixed"
    >
      <aside class="left-sidebar">
        <div>
          <div
            class="brand-logo d-flex align-items-center justify-content-between"
          >
            <a href="./index.html" class="text-nowrap logo-img">
              <img
                src="../assets/images/logos/nidosky.png"
                width="180"
                alt=""
              />
            </a>
            <div
              class="close-btn d-xl-none d-block sidebartoggler cursor-pointer"
              id="sidebarCollapse"
            >
              <i class="ti ti-x fs-8"></i>
            </div>
          </div>
          <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
            <ul id="sidebarnav">
              <li class="sidebar-item">
                <a class="sidebar-link" href="./dashboard.html">
                  <i class="ti ti-layout-dashboard"></i
                  ><span class="hide-menu">Dashboard</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="./Roles.html">
                  <i class="ti ti-id-badge"></i
                  ><span class="hide-menu">Roles</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="./Registro.html">
                  <i class="ti ti-user"></i><span class="hide-menu">Login</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="./apartamentos.html">
                  <i class="ti ti-home"></i
                  ><span class="hide-menu">Apartamentos</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="./descuentos.html">
                  <i class="ti ti-tag"></i
                  ><span class="hide-menu">Descuentos</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="./reservas.html">
                  <i class="ti ti-calendar"></i
                  ><span class="hide-menu">Reservas</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="./hospedaje.html">
                  <i class="ti ti-hotel"></i
                  ><span class="hide-menu">Hospedaje</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </aside>
      <div class="body-wrapper">
        <header class="app-header">
          <nav class="navbar navbar-expand-lg navbar-light">
            <ul class="navbar-nav">
              <li class="nav-item d-block d-xl-none">
                <a
                  class="nav-link sidebartoggler nav-icon-hover"
                  id="headerCollapse"
                  href="javascript:void(0)"
                >
                  <i class="ti ti-menu-2"></i>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link nav-icon-hover" href="javascript:void(0)">
                  <i class="ti ti-bell-ringing"></i>
                  <div class="notification bg-primary rounded-circle"></div>
                </a>
              </li>
            </ul>
            <div
              class="navbar-collapse justify-content-end px-0"
              id="navbarNav"
            >
              <ul
                class="navbar-nav flex-row ms-auto align-items-center justify-content-end"
              >
                <li class="nav-item dropdown">
                  <a
                    class="nav-link nav-icon-hover"
                    href="javascript:void(0)"
                    id="drop2"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <img
                      src="../assets/images/profile/user-1.jpg"
                      alt=""
                      width="35"
                      height="35"
                      class="rounded-circle"
                    />
                  </a>
                  <div
                    class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up"
                    aria-labelledby="drop2"
                  >
                    <div class="message-body">
                      <a
                        href="javascript:void(0)"
                        class="d-flex align-items-center gap-2 dropdown-item"
                      >
                        <i class="ti ti-user fs-6"></i>
                        <p class="mb-0 fs-3">Mi Perfil</p>
                      </a>
                      <a
                        href="javascript:void(0)"
                        class="d-flex align-items-center gap-2 dropdown-item"
                      >
                        <i class="ti ti-mail fs-6"></i>
                        <p class="mb-0 fs-3">Mi Cuenta</p>
                      </a>
                      <a
                        href="javascript:void(0)"
                        class="d-flex align-items-center gap-2 dropdown-item"
                      >
                        <i class="ti ti-list-check fs-6"></i>
                        <p class="mb-0 fs-3">Mis Tareas</p>
                      </a>
                      <a
                        href="./authentication-login.html"
                        class="btn btn-outline-primary mx-3 mt-2 d-block"
                        >Cerrar Sesión</a
                      >
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </nav>
        </header>
      </div>
    </div>
    <div class="container-fluid">
      <div class="container mt-5">
        <div class="d-flex justify-content-between mb-3">
          <button
            class="btn btn-success"
            data-toggle="modal"
            data-target="#descuentoModal"
          >
            <i class="fas fa-plus"></i> Agregar Descuento
          </button>
          <input
            type="text"
            class="form-control w-25"
            id="buscar"
            placeholder="Buscar"
          />
          <button class="btn btn-outline-success" id="exportExcel">
            Exportar a Excel
          </button>
        </div>

        <table id="descuentosTable" class="table table-dark table-striped">
          <thead>
            <tr>
              <th>ID Apartamento</th>
              <th>Descripción</th>
              <th>Precio</th>
              <th>Descuento (%)</th>
              <th>Precio con Descuento</th>
              <th>Fecha Inicio</th>
              <th>Fecha Fin</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <!-- Aquí se agregarán dinámicamente las filas -->
          </tbody>
        </table>

        <!-- Modal para agregar o editar descuento -->
        <div
          class="modal fade"
          id="descuentoModal"
          tabindex="-1"
          role="dialog"
          aria-labelledby="modalTitle"
          aria-hidden="true"
        >
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Agregar Descuento</h5>
                <button
                  type="button"
                  class="close"
                  data-dismiss="modal"
                  aria-label="Close"
                >
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form id="descuentoForm">
                  <div class="form-group">
                    <label for="descripcion">Descripción</label>
                    <input
                      type="text"
                      class="form-control"
                      id="descripcion"
                      placeholder="Descripción del descuento"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="precio">Precio</label>
                    <input
                      type="number"
                      class="form-control"
                      id="precio"
                      placeholder="Precio original"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="descuento">Descuento (%)</label>
                    <input
                      type="number"
                      class="form-control"
                      id="descuento"
                      placeholder="Descuento en porcentaje"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="precioDescuento">Precio con Descuento</label>
                    <input
                      type="number"
                      class="form-control"
                      id="precioDescuento"
                      placeholder="Precio con descuento"
                      readonly
                    />
                  </div>
                  <div class="form-group">
                    <label for="fechaini">Fecha Inicio</label>
                    <input
                      type="date"
                      class="form-control"
                      id="fechaini"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="fechafin">Fecha Fin</label>
                    <input
                      type="date"
                      class="form-control"
                      id="fechafin"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="estado">Estado</label>
                    <select class="form-control" id="estado" required>
                      <option value="activo">Activo</option>
                      <option value="inactivo">Inactivo</option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-primary">
                    Guardar Descuento
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        let editingId = null;

        // Función para calcular el precio con descuento
        function calcularPrecioDescuento() {
          const precio = parseFloat($("#precio").val()) || 0;
          const descuento = parseFloat($("#descuento").val()) || 0;
          if (precio > 0 && descuento >= 0 && descuento <= 100) {
            const precioDescuento = precio - precio * (descuento / 100);
            $("#precioDescuento").val(precioDescuento.toFixed(2));
          } else {
            $("#precioDescuento").val("");
          }
        }

        // Cuando se envía el formulario
        $("#descuentoForm").submit(function (e) {
          e.preventDefault();

          const descripcion = $("#descripcion").val().trim();
          const precio = parseFloat($("#precio").val());
          const descuento = parseFloat($("#descuento").val());
          const precioDescuento = parseFloat($("#precioDescuento").val());
          const fechaini = new Date($("#fechaini").val());
          const fechafin = new Date($("#fechafin").val());
          const estado = $("#estado").val();

          // Validaciones de los campos
          if (
            !descripcion ||
            isNaN(precio) ||
            isNaN(descuento) ||
            isNaN(precioDescuento) ||
            !fechaini ||
            !fechafin ||
            !estado
          ) {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "Todos los campos deben estar completos.",
            });
            return;
          }

          if (descuento < 0 || descuento > 100) {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "El descuento debe estar entre 0 y 100.",
            });
            return;
          }

          if (fechaini >= fechafin) {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "La fecha de inicio debe ser anterior a la fecha de finalización.",
            });
            return;
          }

          const descuentoData = {
            descripcion,
            precio,
            descuento,
            precioDescuento,
            fechaini: $("#fechaini").val(),
            fechafin: $("#fechafin").val(),
            estado,
          };

          const method = editingId ? "PUT" : "POST";
          const url = editingId
            ? `http://localhost:3001/api/descuentos/${editingId}`
            : "http://localhost:3001/api/descuentos";

          // Enviar datos del descuento a la API
          $.ajax({
            url: url,
            method: method,
            contentType: "application/json",
            data: JSON.stringify(descuentoData),
            success: function (response) {
              Swal.fire({
                icon: "success",
                title: "Éxito",
                text: editingId
                  ? "Descuento actualizado exitosamente"
                  : "Descuento agregado exitosamente",
              });

              if (editingId) {
                $(`tr[data-id="${editingId}"]`).remove();
              }

              const newRow = createTableRow(response);
              $("#descuentosTable tbody").append(newRow);

              // Reiniciar el formulario y cerrar el modal
              $("#descuentoForm")[0].reset();
              $("#descuentoModal").modal("hide");
              editingId = null;
            },
            error: function (error) {
              Swal.fire({
                icon: "error",
                title: "Error",
                text:
                  "Error al guardar el descuento: " +
                  (error.responseJSON
                    ? error.responseJSON.message
                    : "Error desconocido"),
              });
            },
          });
        });

        // Calcular el precio con descuento al cambiar el precio o el descuento
        $("#precio, #descuento").on("input", calcularPrecioDescuento);

        // Crear una fila en la tabla con los datos del descuento
        function createTableRow(descuento) {
          const idApartamento = Math.floor(Math.random() * 100) + 1;
          return `<tr data-id="${descuento._id}">
            <td>${idApartamento}</td>
            <td>${descuento.descripcion}</td>
            <td>${descuento.precio}</td>
            <td>${descuento.descuento}</td>
            <td>${descuento.precioDescuento}</td>
            <td>${descuento.fechaini}</td>
            <td>${descuento.fechafin}</td>
            <td>${descuento.estado}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-outline-primary edit-button" data-id="${
                  descuento._id
                }">
                  <i class="fas fa-pencil-alt"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger delete-button" data-id="${
                  descuento._id
                }">
                  <i class="fas fa-trash"></i>
                </button>
                <button class="btn btn-sm btn-outline-success toggle-status-button" data-id="${
                  descuento._id
                }" data-status="${descuento.estado}">
                  <i class="fas fa-toggle-${
                    descuento.estado === "activo" ? "on" : "off"
                  }"></i>
                </button>
              </div>
            </td>
          </tr>`;
        }

        // Función para editar descuento
        $("#descuentosTable").on("click", ".edit-button", function () {
          const row = $(this).closest("tr");
          editingId = $(this).data("id");

          $("#descripcion").val(row.find("td").eq(1).text());
          $("#precio").val(row.find("td").eq(2).text());
          $("#descuento").val(row.find("td").eq(3).text());
          $("#precioDescuento").val(row.find("td").eq(4).text());
          $("#fechaini").val(row.find("td").eq(5).text());
          $("#fechafin").val(row.find("td").eq(6).text());
          $("#estado").val(row.find("td").eq(7).text());

          $("#modalTitle").text("Editar Descuento");
          $("#descuentoModal").modal("show");
        });

        // Función para eliminar descuento
        $("#descuentosTable").on("click", ".delete-button", function () {
          const id = $(this).data("id");

          Swal.fire({
            title: "¿Estás seguro?",
            text: "No podrás revertir esta acción",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Sí, eliminar",
            cancelButtonText: "Cancelar",
          }).then((result) => {
            if (result.isConfirmed) {
              $.ajax({
                url: `http://localhost:3001/api/descuentos/${id}`,
                method: "DELETE",
                success: function () {
                  Swal.fire(
                    "Eliminado",
                    "El descuento ha sido eliminado.",
                    "success"
                  );
                  $(`tr[data-id="${id}"]`).remove();
                },
                error: function (error) {
                  Swal.fire({
                    icon: "error",
                    title: "Error",
                    text:
                      "Error al eliminar el descuento: " +
                      (error.responseJSON
                        ? error.responseJSON.message
                        : "Error desconocido"),
                  });
                },
              });
            }
          });
        });

        // Función para cambiar el estado del descuento
        $("#descuentosTable").on("click", ".toggle-status-button", function () {
          const id = $(this).data("id");
          const newStatus =
            $(this).data("status") === "activo" ? "inactivo" : "activo";

          $.ajax({
            url: `http://localhost:3001/api/descuentos/${id}`,
            method: "PUT",
            contentType: "application/json",
            data: JSON.stringify({ estado: newStatus }),
            success: function (response) {
              $(`tr[data-id="${id}"] td:nth-child(8)`).text(newStatus);
              $(`tr[data-id="${id}"] .toggle-status-button`)
                .data("status", newStatus)
                .find("i")
                .removeClass("fa-toggle-on fa-toggle-off")
                .addClass(`fa-toggle-${newStatus === "activo" ? "on" : "off"}`);

              Swal.fire({
                icon: "success",
                title: "Estado actualizado",
                text: `El estado del descuento ha sido cambiado a ${newStatus}.`,
              });
            },
            error: function (error) {
              Swal.fire({
                icon: "error",
                title: "Error",
                text:
                  "Error al cambiar el estado del descuento: " +
                  (error.responseJSON
                    ? error.responseJSON.message
                    : "Error desconocido"),
              });
            },
          });
        });

        // Exportar a Excel
        $("#exportExcel").click(function () {
          const data = [];
          $("#descuentosTable tr").each(function () {
            const rowData = [];
            $(this)
              .find("td, th")
              .each(function () {
                rowData.push($(this).text());
              });
            data.push(rowData);
          });
          const ws = XLSX.utils.aoa_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Descuentos");
          XLSX.writeFile(wb, "descuentos.xlsx");
        });

        // Funcionalidad del botón de perfil
        $(".nav-link.nav-icon-hover").click(function (e) {
          e.preventDefault();
          $(".dropdown-menu").toggle();
        });

        // Cerrar el menú desplegable al hacer clic fuera de él
        $(document).click(function (e) {
          if (!$(e.target).closest(".nav-item.dropdown").length) {
            $(".dropdown-menu").hide();
          }
        });

        // Funcionalidad de búsqueda
        $("#buscar").on("keyup", function () {
          var value = $(this).val().toLowerCase();
          $("#descuentosTable tbody tr").filter(function () {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
          });
        });
      });
    </script>
  </body>
</html>
