<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nido Sky - Hospedaje</title>
    <link
      rel="shortcut icon"
      type="image/png"
      href="../assets/images/logos/nidosky.png"
    />
    <link rel="stylesheet" href="../assets/css/styles.min.css" />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #e0e0e0;
        color: #333;
      }
      .left-sidebar {
        background-color: #ffffff;
      }
      .brand-logo {
        background-color: #333;
        padding: 20px;
      }
      .sidebar-nav .sidebar-item a {
        color: #333;
      }
      .sidebar-nav .sidebar-item a:hover {
        color: #00a859;
      }
      h5.card-title {
        color: #00a859;
      }
      .btn-primary {
        background-color: #00a859;
        border-color: #00a859;
      }
      .btn-primary:hover {
        background-color: #008f5d;
        border-color: #008f5d;
      }
      .btn-excel {
        background-color: #00a859;
        color: #fff;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
      }
      .btn-excel i {
        margin-right: 5px;
      }
      .dataTables_wrapper .dataTables_paginate {
        display: flex;
        justify-content: center;
        margin-top: 10px;
      }
      .dataTables_wrapper .dataTables_info,
      .dataTables_wrapper .dataTables_length {
        display: none;
      }
      .btn-status {
        border: none;
        border-radius: 30%;
        width: 1.7rem;
        height: 1.7rem;
        color: #fff;
        font-size: 0.5rem;
        cursor: pointer;
        transition: background-color 0.3s, color 0.3s;
      }
      .btn-status:hover {
        opacity: 0.8;
      }
      .table {
        background-color: #2c2c2c;
        color: #e0e0e0;
        font-size: 0.875rem;
      }
      .table th,
      .table td {
        border-color: #444;
        white-space: nowrap;
        padding: 0.5rem;
      }
      .table th {
        font-weight: 600;
      }
      .table td {
        font-weight: 400;
      }
      .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }
      .container {
        background-color: #f8f9fa;
        border-radius: 10px;
        position: relative;
        top: 200px;
        left: 30px;
        width: 6000px;
      }
      .table-dark {
        background-color: #343a40;
      }
      .table-dark th,
      .table-dark td {
        color: #fff;
      }
      .btn-success {
        background-color: #28a745;
        border: none;
      }
      .btn-outline-success {
        border-color: #28a745;
        color: #28a745;
      }
      .modal-content {
        border-radius: 10px;
      }
      .form-control {
        border-radius: 5px;
      }
      .app-header {
        position: relative;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 100%;
      }
      .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }
      .pagination button {
        margin: 0 5px;
        padding: 5px 10px;
        border: 1px solid #00a859;
        background-color: #fff;
        color: #00a859;
        cursor: pointer;
      }
      .pagination button.active {
        background-color: #00a859;
        color: #fff;
      }
      .search-container {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }
      #buscar {
        width: 50%;
      }
    </style>
  </head>
  <body>
    <div
      class="page-wrapper"
      id="main-wrapper"
      data-layout="vertical"
      data-navbarbg="skin6"
      data-sidebartype="full"
      data-sidebar-position="fixed"
      data-header-position="fixed"
    >
      <aside class="left-sidebar">
        <div>
          <div
            class="brand-logo d-flex align-items-center justify-content-between"
          >
            <a href="./index.html" class="text-nowrap logo-img">
              <img
                src="../assets/images/logos/nidosky.png"
                width="180"
                alt=""
              />
            </a>
            <div
              class="close-btn d-xl-none d-block sidebartoggler cursor-pointer"
              id="sidebarCollapse"
            >
              <i class="ti ti-x fs-8"></i>
            </div>
          </div>
          <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
            <ul id="sidebarnav">
              <li class="sidebar-item">
                <a class="sidebar-link" href="./dashboard.html">
                  <i class="ti ti-layout-dashboard"></i
                  ><span class="hide-menu">Dashboard</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="./Roles.html">
                  <i class="ti ti-id-badge"></i
                  ><span class="hide-menu">Roles</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="./Registro.html">
                  <i class="ti ti-user"></i><span class="hide-menu">Login</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="./apartamentos.html">
                  <i class="ti ti-home"></i
                  ><span class="hide-menu">Apartamentos</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="./descuentos.html">
                  <i class="ti ti-tag"></i
                  ><span class="hide-menu">Descuentos</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="./reservas.html">
                  <i class="ti ti-calendar"></i
                  ><span class="hide-menu">Reservas</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="./hospedaje.html">
                  <i class="ti ti-hotel"></i
                  ><span class="hide-menu">Hospedaje</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </aside>
      <div class="body-wrapper">
        <header class="app-header">
          <nav class="navbar navbar-expand-lg navbar-light w-100">
            <ul class="navbar-nav">
              <li class="nav-item d-block d-xl-none">
                <a
                  class="nav-link sidebartoggler nav-icon-hover"
                  id="headerCollapse"
                  href="javascript:void(0)"
                >
                  <i class="ti ti-menu-2"></i>
                </a>
              </li>
            </ul>
            <div
              class="navbar-collapse justify-content-end px-0"
              id="navbarNav"
            >
              <ul
                class="navbar-nav flex-row ms-auto align-items-center justify-content-end"
              >
                <li class="nav-item dropdown">
                  <a
                    class="nav-link nav-icon-hover"
                    href="javascript:void(0)"
                    id="drop2"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <img
                      src="../assets/images/profile/user-1.jpg"
                      alt=""
                      width="35"
                      height="35"
                      class="rounded-circle"
                    />
                  </a>
                  <div
                    class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up"
                    aria-labelledby="drop2"
                  >
                    <div class="message-body">
                      <a
                        href="javascript:void(0)"
                        class="d-flex align-items-center gap-2 dropdown-item"
                        id="viewProfileBtn"
                      >
                        <i class="ti ti-user fs-6"></i>
                        <p class="mb-0 fs-3">Mi Perfil</p>
                      </a>
                      <a
                        href="javascript:void(0)"
                        class="d-flex align-items-center gap-2 dropdown-item"
                      >
                        <i class="ti ti-mail fs-6"></i>
                        <p class="mb-0 fs-3">Mi Cuenta</p>
                      </a>
                      <a
                        href="javascript:void(0)"
                        class="d-flex align-items-center gap-2 dropdown-item"
                      >
                        <i class="ti ti-list-check fs-6"></i>
                        <p class="mb-0 fs-3">Mis Tareas</p>
                      </a>
                      <a
                        href="./authentication-login.html"
                        class="btn btn-outline-primary mx-3 mt-2 d-block"
                        id="logoutBtn"
                        >Cerrar Sesión</a
                      >
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </nav>
        </header>
      </div>
    </div>
    <div class="container mt-8">
      <h2 class="text-success">Hospedaje</h2>
      <div class="search-container">
        <input
          type="text"
          class="form-control"
          id="buscar"
          placeholder="Buscar"
        />
      </div>
      <div class="d-flex justify-content-between mb-3">
        <button
          class="btn btn-success"
          data-toggle="modal"
          data-target="#hospedajeModal"
        >
          <i class="fas fa-plus"></i> Agregar Hospedaje
        </button>
        <button class="btn btn-outline-success" id="exportExcel">
          Exportar a Excel
        </button>
      </div>

      <div id="tableContainer">
        <!-- La tabla se creará dinámicamente aquí -->
      </div>

      <div class="pagination">
        <!-- Los botones de paginación se generarán dinámicamente aquí -->
      </div>

      <!-- Modal para agregar o editar hospedaje -->
      <div
        class="modal fade"
        id="hospedajeModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="modalTitle"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalTitle">Agregar Hospedaje</h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="hospedajeForm">
                <div class="form-group">
                  <label for="idejecucion">ID Ejecución</label>
                  <input
                    type="text"
                    class="form-control"
                    id="idejecucion"
                    readonly
                  />
                </div>
                <div class="form-group">
                  <label for="cliente">Cliente</label>
                  <input
                    type="text"
                    class="form-control"
                    id="cliente"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="idreserva">ID Reserva</label>
                  <input
                    type="text"
                    class="form-control"
                    id="idreserva"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="finicio">Fecha Inicio</label>
                  <input
                    type="date"
                    class="form-control"
                    id="finicio"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="ffin">Fecha Fin</label>
                  <input type="date" class="form-control" id="ffin" required />
                </div>
                <div class="form-group">
                  <label for="fechacheckin">Fecha Check-in</label>
                  <input
                    type="date"
                    class="form-control"
                    id="fechacheckin"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="fechacheckout">Fecha Check-out</label>
                  <input
                    type="date"
                    class="form-control"
                    id="fechacheckout"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="pagoparcial">Pago Parcial</label>
                  <input
                    type="number"
                    class="form-control"
                    id="pagoparcial"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="pagorestante">Pago Restante</label>
                  <input
                    type="number"
                    class="form-control"
                    id="pagorestante"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="pagototal">Pago Total</label>
                  <input
                    type="number"
                    class="form-control"
                    id="pagototal"
                    readonly
                  />
                </div>
                <div class="form-group">
                  <label for="estado">Estado</label>
                  <select class="form-control" id="estado" required>
                    <option value="pendiente">Pendiente</option>
                    <option value="en_curso">En Curso</option>
                    <option value="completado">Completado</option>
                    <option value="cancelado">Cancelado</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="observaciones">Observaciones</label>
                  <textarea class="form-control" id="observaciones" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                  Guardar Hospedaje
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script>
      $(document).ready(function () {
        let currentPage = 1;
        const itemsPerPage = 10;
        let allData = [];
        let editingId = null;
        let lastId = 0;

        // Configuración de toastr
        toastr.options = {
          closeButton: true,
          debug: false,
          newestOnTop: false,
          progressBar: true,
          positionClass: "toast-top-right",
          preventDuplicates: false,
          onclick: null,
          showDuration: "300",
          hideDuration: "1000",
          timeOut: "5000",
          extendedTimeOut: "1000",
          showEasing: "swing",
          hideEasing: "linear",
          showMethod: "fadeIn",
          hideMethod: "fadeOut",
        };

        // Función para generar ID automático
        function generateId() {
          lastId++;
          return `EJE${String(lastId).padStart(3, "0")}`;
        }

        // Función para cargar los datos
        function loadData() {
          $.ajax({
            url: "http://localhost:3001/api/hospedajes",
            method: "GET",
            success: function (data) {
              allData = data;
              lastId = Math.max(
                ...data.map((item) =>
                  parseInt(item.idejecucion.replace("EJE", ""))
                ),
                0
              );
              renderTable();
              renderPagination();
            },
            error: function (error) {
              console.error("Error al cargar los datos:", error);
              toastr.error("Error al cargar los datos");
            },
          });
        }

        // Función para renderizar la tabla
        function renderTable() {
          // Crear la tabla si no existe
          if ($("#hospedajeTable").length === 0) {
            const tableHtml = `
          <table class="table table-dark table-striped" id="hospedajeTable">
            <thead>
              <tr>
                <th>ID Ejecución</th>
                <th>Cliente</th>
                <th>ID Reserva</th>
                <th>Fecha Inicio</th>
                <th>Fecha Fin</th>
                <th>Fecha Check-in</th>
                <th>Fecha Check-out</th>
                <th>Pago Parcial</th>
                <th>Pago Restante</th>
                <th>Pago Total</th>
                <th>Estado</th>
                <th>Observaciones</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <!-- Aquí se agregarán dinámicamente las filas -->
            </tbody>
          </table>
        `;
            $("#tableContainer").append(tableHtml);
          }

          $("#hospedajeTable tbody").empty();
          allData.forEach((item) => {
            $("#hospedajeTable tbody").append(createTableRow(item));
          });
        }

        // Función para renderizar la paginación
        function renderPagination() {
          const totalPages = Math.ceil(allData.length / itemsPerPage);
          $(".pagination").empty();

          for (let i = 1; i <= totalPages; i++) {
            $(".pagination").append(`
          <button class="page-btn ${
            i === currentPage ? "active" : ""
          }" data-page="${i}">${i}</button>
        `);
          }
        }

        // Evento para los botones de paginación
        $(document).on("click", ".page-btn", function () {
          currentPage = parseInt($(this).data("page"));
          renderTable();
          renderPagination();
        });

        // Función de búsqueda
        $("#buscar").on("input", function () {
          const searchTerm = $(this).val().toLowerCase();
          const filteredData = allData.filter(
            (item) =>
              item.idejecucion.toLowerCase().includes(searchTerm) ||
              item.cliente.toLowerCase().includes(searchTerm) ||
              item.idreserva.toLowerCase().includes(searchTerm)
          );
          allData = filteredData;
          currentPage = 1;
          renderTable();
          renderPagination();
        });

        // Función para exportar a Excel
        $("#exportExcel").click(function () {
          const ws = XLSX.utils.json_to_sheet(allData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Hospedajes");
          XLSX.writeFile(wb, "hospedajes.xlsx");
        });

        // Evento para el cierre de sesión
        $("#logoutBtn").click(function (e) {
          e.preventDefault();
          toastr.success("Sesión cerrada exitosamente");
          setTimeout(() => {
            window.location.href = "./authentication-login.html";
          }, 2000);
        });

        // Función para calcular el pago total
        function calcularPagoTotal() {
          const pagoParcial = parseFloat($("#pagoparcial").val()) || 0;
          const pagoRestante = parseFloat($("#pagorestante").val()) || 0;
          const pagoTotal = pagoParcial + pagoRestante;
          $("#pagototal").val(pagoTotal.toFixed(2));
        }

        // Cuando se envía el formulario de hospedaje
        $("#hospedajeForm").submit(function (e) {
          e.preventDefault();

          const idejecucion = $("#idejecucion").val().trim();
          const cliente = $("#cliente").val().trim();
          const idreserva = $("#idreserva").val().trim();
          const finicio = $("#finicio").val();
          const ffin = $("#ffin").val();
          const fechacheckin = $("#fechacheckin").val();
          const fechacheckout = $("#fechacheckout").val();
          const pagoparcial = parseFloat($("#pagoparcial").val());
          const pagorestante = parseFloat($("#pagorestante").val());
          const pagototal = parseFloat($("#pagototal").val());
          const estado = $("#estado").val();
          const observaciones = $("#observaciones").val().trim();

          if (!cliente || !idreserva) {
            toastr.error("Todos los campos son obligatorios.");
            return;
          }

          if (new Date(finicio) >= new Date(ffin)) {
            toastr.error(
              "La fecha de inicio debe ser anterior a la fecha de fin."
            );
            return;
          }

          if (new Date(fechacheckin) > new Date(fechacheckout)) {
            toastr.error(
              "La fecha de check-in debe ser anterior o igual a la fecha de check-out."
            );
            return;
          }

          if (isNaN(pagoparcial) || isNaN(pagorestante) || isNaN(pagototal)) {
            toastr.error("Los pagos deben ser números válidos.");
            return;
          }

          const hospedajeData = {
            idejecucion: idejecucion || generateId(),
            cliente,
            idreserva,
            finicio,
            ffin,
            fechacheckin,
            fechacheckout,
            pagoparcial,
            pagorestante,
            pagototal,
            estado,
            observaciones,
          };

          const method = editingId ? "PUT" : "POST";
          const url = editingId
            ? `http://localhost:3001/api/hospedajes/${editingId}`
            : "http://localhost:3001/api/hospedajes";

          // Enviar datos del hospedaje a la API
          $.ajax({
            url: url,
            method: method,
            contentType: "application/json",
            data: JSON.stringify(hospedajeData),
            success: function (response) {
              toastr.success(
                editingId
                  ? "Hospedaje actualizado exitosamente"
                  : "Hospedaje agregado exitosamente"
              );

              if (editingId) {
                const index = allData.findIndex(
                  (item) => item._id === editingId
                );
                if (index !== -1) {
                  allData[index] = response;
                }
              } else {
                allData.push(response);
              }

              renderTable();
              renderPagination();

              // Reiniciar el formulario y cerrar el modal
              $("#hospedajeForm")[0].reset();
              $("#hospedajeModal").modal("hide");
              editingId = null;
            },
            error: function (error) {
              toastr.error(
                "Error al guardar el hospedaje: " +
                  (error.responseJSON
                    ? error.responseJSON.message
                    : "Error desconocido")
              );
            },
          });
        });

        // Calcular el pago total al cambiar el pago parcial o restante
        $("#pagoparcial, #pagorestante").on("input", calcularPagoTotal);

        // Crear una fila en la tabla con los datos del hospedaje
        function createTableRow(hospedaje) {
          return `<tr data-id="${hospedaje._id}">
        <td>${hospedaje.idejecucion}</td>
        <td>${hospedaje.cliente}</td>
        <td>${hospedaje.idreserva}</td>
        <td>${hospedaje.finicio}</td>
        <td>${hospedaje.ffin}</td>
        <td>${hospedaje.fechacheckin}</td>
        <td>${hospedaje.fechacheckout}</td>
        <td>${hospedaje.pagoparcial}</td>
        <td>${hospedaje.pagorestante}</td>
        <td>${hospedaje.pagototal}</td>
        <td>${hospedaje.estado}</td>
        <td>${hospedaje.observaciones}</td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-sm btn-outline-primary edit-button" data-id="${hospedaje._id}">
              <i class="fas fa-pencil-alt"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger delete-button" data-id="${hospedaje._id}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>`;
        }

        // Función para editar hospedaje
        $("#tableContainer").on("click", ".edit-button", function () {
          const id = $(this).data("id");
          editingId = id;
          const hospedaje = allData.find((item) => item._id === id);

          $("#idejecucion").val(hospedaje.idejecucion);
          $("#cliente").val(hospedaje.cliente);
          $("#idreserva").val(hospedaje.idreserva);
          $("#finicio").val(hospedaje.finicio.split("T")[0]);
          $("#ffin").val(hospedaje.ffin.split("T")[0]);
          $("#fechacheckin").val(hospedaje.fechacheckin.split("T")[0]);
          $("#fechacheckout").val(hospedaje.fechacheckout.split("T")[0]);
          $("#pagoparcial").val(hospedaje.pagoparcial);
          $("#pagorestante").val(hospedaje.pagorestante);
          $("#pagototal").val(hospedaje.pagototal);
          $("#estado").val(hospedaje.estado);
          $("#observaciones").val(hospedaje.observaciones);

          $("#modalTitle").text("Editar Hospedaje");
          $("#hospedajeModal").modal("show");
        });

        // Función para eliminar hospedaje
        $("#tableContainer").on("click", ".delete-button", function () {
          const id = $(this).data("id");

          if (confirm("¿Está seguro de que desea eliminar este hospedaje?")) {
            $.ajax({
              url: `http://localhost:3001/api/hospedajes/${id}`,
              method: "DELETE",
              success: function () {
                toastr.success("Hospedaje eliminado exitosamente");
                allData = allData.filter((item) => item._id !== id);
                renderTable();
                renderPagination();
              },
              error: function (error) {
                toastr.error(
                  "Error al eliminar el hospedaje: " +
                    (error.responseJSON
                      ? error.responseJSON.message
                      : "Error desconocido")
                );
              },
            });
          }
        });

        // Manejar el envío del formulario de perfil
        $("#profileForm").submit(function (e) {
          e.preventDefault();
          toastr.success("Perfil actualizado exitosamente");
          $("#profileModal").modal("hide");
        });

        // Cargar datos iniciales
        loadData();
      });
    </script>
  </body>
</html>